node{
    
    def mavenHome= tool name: "Maven3.6.3"
    def buildnumber= BUILD_NUMBER
    stage ('Git CheckOut'){
        
        git branch: 'master', url: 'https://github.com/HarshithaKuppam/maven-web-application.git'
    }
    stage('build maven package'){
        
        sh " ${mavenHome}/bin/mvn clean package "
    }
    stage('Build Docker Image'){
        
        sh " docker build -t kuppamdocker/maven-web-application:${buildnumber} ."
    }
    
    stage('Docker Login and Push'){
        
       withCredentials([usernameColonPassword(credentialsId: 'Docker_Hub_Pwd', variable: 'Docker_Hub_Pwd')]) {
       sh "docker login -u kuppamdocker -p H@rshihari03 "
    }
           
         sh "docker push kuppamdocker/maven-web-application:${buildnumber}"
    }
    
    stage('Removing Local Image'){
        
        sh " docker rmi -f kuppamdocker/maven-web-application:${buildnumber}"
    }
    
   stage('Replacing tag in manifest file'){
        
        sh " sed -i 's/#BUILD_NUMBER/${buildnumber}/' mavenwebappdeployment.yaml"
        
    }
    
   stage('Deploy app in dev k8 cluster'){
    
       //withKubeConfig([credentialsId: 'kubeconfignew',serverUrl: 'https://79F13A2FF679E5A8D118AD8C68E34329.gr7.eu-west-1.eks.amazonaws.com',contextName: 'devcluster',clusterName: 'EKS_Demo']) {
      sh 'kubectl config use-context devcluster'
      sh 'kubectl apply -f  mavenwebappdeployment.yaml'
    
   // }
    }
    
  stage('Deploy app in qa k8 cluster'){
  
      withKubeConfig([credentialsId: 'kubeconfignew',serverUrl: 'https://F8F89E0C03D25C3DA3B78EE8B5E8F91F.yl4.eu-west-1.eks.amazonaws.com',contextName: 'qacluster',clusterName: 'EKS_NewCluster']) {
       sh 'kubectl config use-context qacluster'
      sh 'kubectl apply -f  mavenwebappdeployment.yaml'
    }
    
  }

} //node closing
